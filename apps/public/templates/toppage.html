{% extends "page.html" %}

{% block cssfile %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/highlight/tomorrow-night.css"></link>

{% endblock %}

{% block content %}
<div class="inner-section inner-header">
	<div class="about-this-container">
		<div class="title-container">
			<h1 class="title">ConnectSynth</h1>
			<div class="socialbuttons">
					<div id="twitter" class="socialbutton"></div>
					<div id="facebook_like" class="socialbutton"></div>
					<div id="google_plusone" class="socialbutton"></div>
			</div>
		</div>
		<p class="description">WebAudioWorker(WAW)プラグインの実験サイトです。誰でもWAW楽器の作成、テスト、公開が出来ます。また公開された楽器をコピー、改変し、公開することも可能です。</p>
	</div>
	<div class="open-instrument-container">
		<a class="open-instrument" href="{% url sdk_instrument_workspace %}">Open Workspace</a>	
	</div>
</div>
<div class="inner-section plugin-area">
	<div class="section-title">
		<h2 id="instruments">公開された楽器</h2>
	</div>
	<div class="plugin-list">
	{% for plugin in object_list %}
		<div class="plugin-block">
		    <div class="plugin-header">
		    	<div class="plugin-created">
			    	<p>by <a href='https://twitter.com/{{ plugin.user.twitteruser.screen_name }}/' target="_blank">{{ plugin.user.twitteruser.screen_name }}</a>
			    		at {{ plugin.createdat|date:"Y/m/d" }}</p>
		    	</div>
		    	<div class="plugin-title">
		    		<h3><a href='{% url sdk_instrument_player plugin.code %}'>{{ plugin.name }}</a></h2>
		    	</div>
		    </div>
			<div class="plugin-info">
			    
			    <p>{{ plugin.description|linebreaks }}</p>
		    </div>
		</div>
	{% endfor %}
	</div>

</div>
<div class="inner-section develop-info">
	<div class="section-title">
		<h2 id="document">プラグイン仕様</h2>
	</div>
	<div class="document">
		<div class="section">
			<h3>概要</h3>
			<p>WAWはJavascriptで書かれたWeb音源のプラグイン規格です。
				WebAudioAPI/AudioDataAPIに対応しているブラウザ(Chrome、Safari、Firefoxなど)上での動作を想定しています。
				プラグインとホストはそれぞれ別のプロセス上で動作し、ホストがmain.jsをWebWorkerとして呼び出すことでプラグインは起動します。以下はシンプルな例です。</p>
			<ul>
				<li>main.js</li>
			</ul>
			<pre><code class="javascript">
addEventListener('message', onGetWave, false);

var sampleRate, currentRadian = 0, freqPerSample = false;

function onGetWave(e) {
	var request = e.data, response = {
		callback : request.callback
	};
	
	switch(request.action) {
		case 'init':
			sampleRate = request.samplerate;
			break;
		case 'midi':
			switch(request.type) {
				case "noteon":
					var freq = 440 * Math.pow(2, (request.note / 12) - 5) * 2 * Math.PI;
					freqPerSample = freq / sampleRate;
					break;
				case "noteoff":
				case "notealloff":
				default:
					freqPerSample = false;
					break;
			}
			break;
		case 'getbuffer':
			var buffer = new Float32Array(request.length);
			if(freqPerSample !== false) {
				for(var i = 0; i < request.length; i++) {
					currentRadian += freqPerSample;
					buffer[i] = Math.sin(currentRadian);
				}
			}
			response.leftbuffer = buffer;
			response.rightbuffer = buffer;
			break;
		default:
			return;
	}

	postMessage(response);
};
			</code></pre>
			<p>
				以下では上記サンプルのrequestを<strong>リクエスト</strong>、responseを<strong>レスポンス</strong>と呼びます。
				プラグインは各リクエスト毎にレスポンスをホストに送信しなければなりません。
			</p>
			<p>
				すべてのリクエストは以下の属性を共通で持ちます。
			</p>
			<table>
				<tbody><tr>
					<th>リクエスト属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} action</td>
					<td>リクエストの種類を表します。"init"、"set"、"midi"、"getbuffer"の4種類があります。</td>
				</tr>
				<tr>
					<td>{String} callback</td>
					<td>ホスト側でコールバックで呼ばれる関数の名前です。レスポンスに属性として付加します。</td>
				</tr>
				</tbody>
			</table>
		</div>
		
		<div class="section">	
			<h3>リクエストとレスポンス</h3>
			<p>ここではタイプに応じたリクエスト、レスポンスの説明をします。</p>
			<h4 class="first">initリクエスト</h4>
			<p>
				プラグインをホストが起動して最初に呼ばれます。
			</p>
			<table>
				<tbody>
				<tr>
					<th>リクエスト属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{Number} samplerate</td>
					<td>サンプリング周波数[Hz]</td>
				</tr>
				</tbody>
			</table>
			<table>
				<tbody>
				<tr>
					<th>レスポンス属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{Object} controller</td>
					<td>パラメータとGUIコントローラを設定します。</td>
				</tr>
				</tbody>
			</table>
			
			<h4>setリクエスト</h4>
			<p>
				プラグイン側で設定したパラメータにGUIコントローラなどから変更が加えられたときに呼ばれます。パラメータの設定方法については後述のGUIコントローラの説明で行います。
			</p>
			<table>
				<tbody>
				<tr>
					<th>リクエスト属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} id</td>
					<td>変更されたパラメータのid</td>
				</tr>
				<tr>
					<td>{String|Number} value</td>
					<td>変更されたパラメータの値</td>
				</tr>
				</tbody>
			</table>
			<p>
				レスポンスには特に追加する属性はありません。
			</p>
			<h4>midiリクエスト</h4>
			<p>
				midiイベントを受信します。
			</p>
			<table>
				<tbody>
				<tr>
					<th>リクエスト属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} type</td>
					<td>MIDIイベントのタイプです。"noteon"、"noteoff"、"notealloff"の種類があります。</td>
				</tr>
				<tr>
					<td>{Number} note</td>
					<td>"noteon"、"noteoff"の場合のMIDIノート番号です。</td>
				</tr>
				<tr>
					<td>{Number} verocity</td>
					<td>"noteon"の場合のベロシティです。範囲は[0, 1]です。</td>
				</tr>
				</tbody>
			</table>
			<p>
				レスポンスには特に追加する属性はありません。
			</p>
			
			<h4>getbufferリクエスト</h4>
			<p>
				サンプリングデータを要求します。
			</p>
			<table>
				<tbody>
				<tr>
					<th>リクエスト属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{Number} length</td>
					<td>データバッファーのサイズ</td>
				</tr>
				</tbody>
			</table>
			<table>
				<tbody>
				<tr>
					<th>レスポンス属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{Float32Array} rightbuffer</td>
					<td>右サンプルバッファーです。</td>
				</tr>
				<tr>
					<td>{Float32Array} leftbuffer</td>
					<td>左サンプルバッファーです。</td>
				</tr>
				</tbody>
			</table>			
		</div>

		<div class="section">
			<h3>GUIコントローラの設定</h3>
			<p>initリクエストに対するレスポンスのcontroller属性がGUIを定義します。</p>
			
			<h4 class="first">controller.background</h4>
			<p>背景画像の設定を行います。</p>
			<table>
				<tbody>
				<tr>
					<th>controller属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} image</td>
					<td>背景画像の相対URLです</td>
				</tr>
				<tr>
					<td>{String} height</td>
					<td>背景画像の縦pixelです</td>
				</tr>
				<tr>
					<td>{String} width</td>
					<td>背景画像の幅pixelです</td>
				</tr>
				</tbody>
			</table>				
			
			<h4>controller.controls</h4>
			<p>各GUIコントロールの情報を配列で設定します。コントロールには"knob"、"toggle"、"radio"の種類があります。</p>
			<table>
				<tbody>
				<tr>
					<th>control共通属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} type</td>
					<td>"knob"、"toggle"、"radio"のうちどれかのタイプを指定します。</td>
				</tr>
				<tr>
					<td>{String} id</td>
					<td>idを指定します。setリクエストのid属性に対応します。</td>
				</tr>
				<tr>
					<td>{String|Number} value</td>
					<td>初期値です。</td>
				</tr>
				<tr>
					<td>{Number} height</td>
					<td>画像の縦pixelです。</td>
				</tr>
				<tr>
					<td>{Number} width</td>
					<td>画像の幅pixelです。</td>
				</tr>
				</tbody>
			</table>		
		
			<h4>knobコントロール</h4>
			<p>回転ノブです。ノブは真上を中心として270°回転します。</p>
			<table>
				<tbody>
				<tr>
					<th>control属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} image</td>
					<td>コントロール画像の相対URLです。</td>
				</tr>
				<tr>
					<td>{Number} offsetx</td>
					<td>コントロール画像の背景画像左上を原点としたときの右方向オフセットpixelです。</td>
				</tr>
				<tr>
					<td>{Number} offsety</td>
					<td>コントロール画像の背景画像左上を原点としたときの下方向オフセットpixelです。</td>
				</tr>
				<tr>
					<td>{Number} min</td>
					<td>[optional]<br/>
						最小値です。デフォルトは0です。</td>
				</tr>
				<tr>
					<td>{Number} max</td>
					<td>[optional]<br/>
						最大値です。デフォルトは1です。</td>
				</tr>
				<tr>
					<td>{Number} step</td>
					<td>[optional]<br/>
						ステップ値です。デフォルトは0.001です。</td>
				</tr>
				<tr>
					<td>{boolean} label</td>
					<td>[optional]<br/>
						ラベルを表示するフラグです。デフォルトはfalseです。</td>
				</tr>
				<tr>
					<td>{Number} labeloffsetx</td>
					<td>[optional]<br/>
						label==trueのときに任意で右方向へのオフセット値を設定できます。<br/>
						デフォルトは0でコントロールの回転中心を中心とした位置に配置されます。</td>
				</tr>
				<tr>
					<td>{Number} labeloffsety</td>
					<td>[optional]<br/>
						label==trueのときに任意で下方向へのオフセット値を設定できます。<br/>
						デフォルトは0でコントロールの回転中心を中心とした位置に配置されます。</td>
				</tr>
				<tr>
					<td>{String} labelprefix</td>
					<td>[optional]<br/>label==trueのときに任意でラベルの接頭文字を設定できます。</td>
				</tr>
				<tr>
					<td>{String} labelpostfix</td>
					<td>[optional]<br/>label==trueのときに任意でラベルの接尾文字を設定できます。</td>
				</tr>
				</tbody>
			</table>
			
			<h4>toggleコントロール</h4>
			<p>トグルボタンです。setリクエストのvalue属性にはbooleanが設定されます。</p>
			<table>
				<tbody>
				<tr>
					<th>control属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} imageon</td>
					<td>オンのときの画像相対URLです。</td>
				</tr>
				<tr>
					<td>{String} imageoff</td>
					<td>オフのときの画像の相対URLです。</td>
				</tr>
				<tr>
					<td>{Number} offsetx</td>
					<td>コントロール画像の背景画像左上を原点としたときの右方向オフセットpixelです。</td>
				</tr>
				<tr>
					<td>{Number} offsety</td>
					<td>コントロール画像の背景画像左上を原点としたときの下方向オフセットpixelです。</td>
				</tr>
				</tbody>
			</table>
			
			<h4>radioコントロール</h4>		
			<p>ラジオボタンです。setリクエストのvalue属性には、下表のoffsets属性で設定したラジオボタン配列のインデックス値が設定されます。</p>
			<table>
				<tbody>
				<tr>
					<th>control属性</th>
					<th>説明</th>
				</tr>
				<tr>
					<td>{String} imageon</td>
					<td>オンのときの画像相対URLです。</td>
				</tr>
				<tr>
					<td>{String} imageoff</td>
					<td>オフのときの画像の相対URLです。</td>
				</tr>
				<tr>
					<td>{Array} offsets</td>
					<td>{Number} offsetx、{Number} offsetyを要素としたオブジェクトの配列です。</td>
				</tr>
				</tbody>
			</table>
		</div>
		
		<div class="section">
			<h3>デバッグ方法</h3>
			<p>WebWorker内ではconsole.logなどのデバッグ用のAPIが提供されていません。プラグイン内でのオブジェクトの中身を確認したい場合は、callback要素を持たないオブジェクトをpostMessage()してください。そうすればホスト側のJavascriptコンソールで確認することが出来ます。</p>
		</div>
	</div>
	
</div>
{% endblock %}

{% block footer %}
	<p>
		© 2012. Yosuke Asano. | <a href="http://asaby.hatenablog.com/">blog</a>
	</p>
{% endblock %}


{% block scriptfile %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}js//highlight.pack.js"></script>
<script type="text/javascript">
(function(){
	$(function(){
		{# arrange plugin-block like pinterest style #}
		if( $("div.plugin-block").length>2 ) {
			
			var $firstBlock = $("div.plugin-block:eq(0)"),
				$secondBlock = $("div.plugin-block:eq(1)");
				
			var height = 0, leftBottom = 0, rightBottom = 0, leftX = 0,
				rightX = $secondBlock.offset().left - $firstBlock.offset().left,
				margin = parseFloat($firstBlock.css("marginRight")) + 
					parseFloat($firstBlock.css("borderTopWidth")) +
					parseFloat($firstBlock.css("borderBottomWidth"));
			
			
			$("div.plugin-block").each(function(i, blockElem){
				var $block = $(blockElem); 
				if( leftBottom <= rightBottom ) {
					$block.css({
						"position": "absolute",
						"top": leftBottom,
						"left": leftX});
					leftBottom += $block.height()+margin; 
				}
				else {
					$block.css({
						"position": "absolute",
						"top": rightBottom,
						"left": rightX});
					rightBottom += $block.height()+margin;
				}
			});
			$("div.plugin-list").height(Math.max(leftBottom, rightBottom));
		}
		
		hljs.initHighlighting();
		
		(function(){
			$('#google_plusone').socialbutton('google_plusone', {
				lang: 'ja',
				size: 'medium'
			}).width(65);
			$('#hatena').socialbutton('hatena');
			$('#twitter').socialbutton('twitter', {
				button: 'horizontal',
		        text: 'ConnectSynth'
			}).width(90);
			$('#facebook_like').socialbutton('facebook_like', {
				button: 'button_count'
			}).width(105);
		})();
	});
})();
</script>
{% endblock %}

